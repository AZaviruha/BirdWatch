@(tweets: Seq[Tweet])(implicit request: RequestHeader)

@mainEmpty("Tweets!") {
  <script src="@routes.Assets.at("javascripts/d3.min.js")" type="text/javascript"></script>
  <script src="@routes.Assets.at("javascripts/d3.layout.cloud.js")" type="text/javascript"></script>
  <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/dw.css")">
  
  <script type="text/javascript">
  $(function() {
    var ws = new WebSocket("@routes.Twitter.tweetFeed.webSocketURL()")

    // Overall viewmodel for this screen, along with initial state
    var TweetsViewModel = function() {
      this.tweets = ko.observableArray();
    }
    var viewModel = new TweetsViewModel()
    ko.applyBindings(viewModel);
    
    var w = 960, h = 600;
    
    // d3 word cloud
    var fill = d3.scale.category20();
    var fontSize = d3.scale.log().range([10, 90]);
        
    var wordList = [{word: "a", size: 79}, {word: "b", size: 78}, {word: "c", size: 77}, {word: "", size: 60}, {word: "", size: 60}, 
      {word: "", size: 60}]
    

    fScale = d3.scale.linear().domain([0, d3.max(wordList, function(d) { return d.size; })]).range([10, 70]);
    
    // var layout = d3.layout.cloud()
    //     .timeInterval(10)
    //     .size([w, h])
    //     .fontSize(function(d) { return fontSize(+d.value); })
    //     .text(function(d) { return d.key; })
    //     .on("end", draw);
    
    var layout = d3.layout.cloud()
          .size([w, h])
          .timeInterval(10)
          .text(function(d) { return d.word; })
          .font("Impact")
          .fontSize(function(d) { return fontSize(+d.size); })
          //.rotate(function(d) { return ~~(Math.random() * 5) * 30 - 60; })
          .padding(1)
          .words(wordList)
          .spiral("archimedean")
          .on("end", draw)
          .start();

    var svg = d3.select("#wordcloud").append("svg")
        .attr("width", w)
        .attr("height", h);

    var background = svg.attr("width", w)
            .attr("height", h)
            .append("g");
            
    //var svg = d3.select("#wordcloud").append("svg")
    
    function draw() {
      svg.attr("width", w)
          .attr("height", h)
          .append("g")
          .attr("transform", "translate(150,150)")
          .selectAll("text")
          .data(wordList)
          .enter().append("text")
          .style("font-size", function(d) { return d.size / 2 + "px"; })
          .style("font-family", "Impact")
          .style("fill", function(d, i) { return fill(i); })
          .attr("text-anchor", "middle")          
          .attr("transform", function(d) {
            return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
          })
          .text(function(d) { return d.word; });
    }

    function refresh() {
      svg.selectAll("text") 
          .data(wordList)
          .transition().duration(500)
          //.attr("transform", "translate(150,150)")
          .style("font-size", function(d) { return fScale(d.size) + "px"; })
          //.style("font-family", "Impact")
          .style("fill", function(d, i) { return fill(i); })
          .attr("text-anchor", "middle")
          .attr("transform", function(d) {
            console.log("dx dy " + d.x + " " + d.y)
            return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
          })          
          .text(function(d) { return d.word; });
    }
    
    function generate(data) {
      layout
          .font("Impact")
          .spiral("archimedean");
      fontSize = d3.scale["log"]().range([10, 100]);
      //if (tags.length) fontSize.domain([+tags[tags.length - 1].value || 1, +tags[0].value]);
      complete = 0;
      words = [];
      console.log(layout);
      layout.stop().words(data).start();
    }
    
    console.log(layout)
    
    console.log(svg.selectAll("text"))
    
    
    ws.onmessage = function(msg){
      //console.log(msg.data)
      var data = JSON.parse(msg.data)
      viewModel.tweets(data.tweetList)
      wordList = data.topWords
      
      console.log(svg.selectAll("text"))
      
      fScale = d3.scale.linear().domain([0, d3.max(wordList, function(d) { return d.size; })]).range([10, 70]);
      
      layout.stop();
      layout.words(wordList)
      layout.start();
      
      //layout.words(wordList)
      //generate(wordList);
      //refresh();
    }
  })
  </script>
  
  <div id="header"><h1>BirdWatch</h1></div>

  <div id="wordcloud"></div>

  <div id="tweets">
    <ul data-bind="foreach: tweets">
      <li><span class="screen_name" data-bind="text: screen_name"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="timeInterval" data-bind="text: timestamp"></span><br /><span data-bind="text: text"><br /></span></li>
    </ul>
  </div>
  
  @tweets.map { tweet =>
  <!--ul>
    <li><span>@tweet.screen_name</span>: @tweet.text - @tweet.created_at
  </ul-->
  } 

}